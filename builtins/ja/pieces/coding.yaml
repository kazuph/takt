# Coding TAKT Piece
# Plan -> Implement -> Parallel Review (AI + Architecture) -> Fix if needed
#
# 計画と並列レビューを備えた軽量な開発ピース。
# architect-plannerが要件を調査・整理し、不明点はコードを読んで自力で解決する。
# 並列レビュー後、問題がなければ直接完了し、高速なフィードバックループを実現。
#
# フロー:
# plan (要件調査・計画)
#   ↓
# implement (実装)
#   ↓
# reviewers (並列レビュー)
# ├─ ai_review (AI特有問題検出)
# └─ arch-review (設計準拠性確認)
#   ↓
#  [判定]
#   ├─ all(approved) → COMPLETE
#   └─ any(needs_fix) → fix → reviewers (再レビュー)
#
# Template Variables (auto-injected by buildInstruction):
#   {iteration}      - Piece-wide turn count (total movements executed across all agents)
#   {max_iterations} - Maximum iterations allowed for the piece
#   {movement_iteration} - Per-movement iteration count (how many times THIS movement has been executed)
#   {task}           - Original user request
#   {previous_response} - Output from the previous movement
#   {user_inputs}    - Accumulated user inputs during piece
#   {report_dir}     - Report directory name (e.g., "20250126-143052-task-summary")

name: coding
description: Lightweight development piece with planning and parallel reviews (plan -> implement -> parallel review -> complete)

max_iterations: 20

policies:
  coding: ../policies/coding.md
  review: ../policies/review.md
  testing: ../policies/testing.md
  ai-antipattern: ../policies/ai-antipattern.md

knowledge:
  architecture: ../knowledge/architecture.md

personas:
  architect-planner: ../personas/architect-planner.md
  coder: ../personas/coder.md
  ai-antipattern-reviewer: ../personas/ai-antipattern-reviewer.md
  architecture-reviewer: ../personas/architecture-reviewer.md

instructions:
  plan: ../instructions/plan.md
  implement: ../instructions/implement.md
  ai-review: ../instructions/ai-review.md
  review-arch: ../instructions/review-arch.md
  fix: ../instructions/fix.md

output_contracts:
  plan: ../output-contracts/plan.md
  ai-review: ../output-contracts/ai-review.md
  architecture-review: ../output-contracts/architecture-review.md

initial_movement: plan

movements:
  - name: plan
    edit: false
    persona: architect-planner
    report:
      name: 00-plan.md
      format: plan
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
      - WebSearch
      - WebFetch
    rules:
      - condition: 要件が明確で実装可能
        next: implement
      - condition: ユーザーが質問をしている（実装タスクではない）
        next: COMPLETE
      - condition: 要件が不明確、情報不足
        next: ABORT
    instruction: plan

  - name: implement
    edit: true
    persona: coder
    policy:
      - coding
      - testing
    session: refresh
    knowledge: architecture
    report:
      - Scope: 02-coder-scope.md
      - Decisions: 03-coder-decisions.md
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    permission_mode: edit
    rules:
      - condition: 実装完了
        next: reviewers
      - condition: 実装未着手（レポートのみ）
        next: reviewers
      - condition: 判断できない、情報不足
        next: reviewers
      - condition: ユーザー入力が必要
        next: implement
        requires_user_input: true
        interactive_only: true
    instruction: implement

  - name: reviewers
    parallel:
      - name: ai_review
        edit: false
        persona: ai-antipattern-reviewer
        policy:
          - review
          - ai-antipattern
        report:
          name: 04-ai-review.md
          format: ai-review
        allowed_tools:
          - Read
          - Glob
          - Grep
          - WebSearch
          - WebFetch
        rules:
          - condition: AI特有の問題なし
          - condition: AI特有の問題あり
        instruction: ai-review

      - name: arch-review
        edit: false
        persona: architecture-reviewer
        policy: review
        knowledge: architecture
        report:
          name: 05-architect-review.md
          format: architecture-review
        allowed_tools:
          - Read
          - Glob
          - Grep
          - WebSearch
          - WebFetch
        rules:
          - condition: approved
          - condition: needs_fix
        instruction: review-arch

    rules:
      - condition: all("AI特有の問題なし", "approved")
        next: COMPLETE
      - condition: any("AI特有の問題あり", "needs_fix")
        next: fix

  - name: fix
    edit: true
    persona: coder
    policy:
      - coding
      - testing
    knowledge: architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    permission_mode: edit
    rules:
      - condition: 修正完了
        next: reviewers
      - condition: 判断できない、情報不足
        next: ABORT
    instruction: fix
