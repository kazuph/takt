# Review-Only Piece
# Reviews code or PRs without making any edits
# Local: console output only. PR specified: posts inline comments + summary to PR
#
# Flow:
# plan -> reviewers (parallel: arch-review + security-review + ai-review) -> supervise
#   -> pr-comment -> COMPLETE (PR comment requested)
#   -> COMPLETE (local: console output only)
#   -> ABORT (rejected)
#
# All movements have edit: false (no file modifications)
#
# Template Variables:
#   {iteration}         - Piece-wide turn count
#   {max_iterations}    - Maximum iterations allowed
#   {movement_iteration}    - Per-movement iteration count
#   {task}              - Original user request
#   {previous_response} - Output from the previous movement
#   {user_inputs}       - Accumulated user inputs
#   {report_dir}        - Report directory name

name: review-only
description: Review-only piece - reviews code without making edits

max_iterations: 10

policies:
  review: ../policies/review.md
  ai-antipattern: ../policies/ai-antipattern.md

knowledge:
  architecture: ../knowledge/architecture.md
  security: ../knowledge/security.md

personas:
  planner: ../personas/planner.md
  architecture-reviewer: ../personas/architecture-reviewer.md
  security-reviewer: ../personas/security-reviewer.md
  ai-antipattern-reviewer: ../personas/ai-antipattern-reviewer.md
  supervisor: ../personas/supervisor.md
  pr-commenter: ../personas/pr-commenter.md

instructions:
  review-arch: ../instructions/review-arch.md
  review-security: ../instructions/review-security.md
  review-ai: ../instructions/review-ai.md

output_contracts:
  architecture-review: ../output-contracts/architecture-review.md
  security-review: ../output-contracts/security-review.md
  ai-review: ../output-contracts/ai-review.md
  review-summary: ../output-contracts/review-summary.md

initial_movement: plan

movements:
  - name: plan
    edit: false
    persona: planner
    allowed_tools:
      - Read
      - Glob
      - Grep
      - WebSearch
      - WebFetch
    rules:
      - condition: Review scope is clear
        next: reviewers
      - condition: User is asking a question (not a review task)
        next: COMPLETE
      - condition: Requirements unclear, insufficient info
        next: ABORT
        appendix: |
          Clarifications needed:
          - {Question 1}
          - {Question 2}
    instruction_template: |
      ## Previous Response (when returned from supervise)
      {previous_response}

      Analyze the review request and create a review plan.

      **This is a review-only piece.** No code edits will be made.
      Focus on:
      1. Identify which files/modules to review
      2. Determine review focus areas (architecture, security, AI patterns, etc.)
      3. Note any specific concerns mentioned in the request

      **If a PR number is mentioned** (e.g., "PR #42"), include it in your plan
      so reviewers can focus on the PR's changed files.

  - name: reviewers
    parallel:
      - name: arch-review
        edit: false
        persona: architecture-reviewer
        policy: review
        knowledge: architecture
        report:
          name: 01-architect-review.md
          format: architecture-review
        allowed_tools:
          - Read
          - Glob
          - Grep

          - WebSearch
          - WebFetch
        rules:
          - condition: approved
          - condition: needs_fix
        instruction: review-arch

      - name: security-review
        edit: false
        persona: security-reviewer
        policy: review
        knowledge: security
        report:
          name: 02-security-review.md
          format: security-review
        allowed_tools:
          - Read
          - Glob
          - Grep

          - WebSearch
          - WebFetch
        rules:
          - condition: approved
          - condition: needs_fix
        instruction: review-security

      - name: ai-review
        edit: false
        persona: ai-antipattern-reviewer
        policy:
          - review
          - ai-antipattern
        report:
          name: 03-ai-review.md
          format: ai-review
        allowed_tools:
          - Read
          - Glob
          - Grep

          - WebSearch
          - WebFetch
        rules:
          - condition: approved
          - condition: needs_fix
        instruction: review-ai
    rules:
      - condition: all("approved")
        next: supervise
      - condition: any("needs_fix")
        next: supervise

  - name: supervise
    edit: false
    persona: supervisor
    policy: review
    report:
      - Review Summary: 04-review-summary.md
    allowed_tools:
      - Read
      - Glob
      - Grep
      - WebSearch
      - WebFetch
    rules:
      - condition: approved, PR comment requested
        next: pr-comment
      - condition: approved
        next: COMPLETE
      - condition: rejected
        next: ABORT
    instruction_template: |
      ## Review Results
      {previous_response}

      **This is a review-only piece.** Do NOT run tests or builds.
      Your role is to synthesize the review results and produce a final summary.

      **Tasks:**
      1. Read all review reports in the Report Directory
      2. Synthesize findings from architecture, security, and AI reviews
      3. Produce a consolidated review summary with overall verdict
      4. Determine routing:
         - If the task mentions posting to a PR (e.g., "post comments to PR", "comment on PR"),
           route to `pr-comment` movement (condition: "approved, PR comment requested")
         - If local review only, route to COMPLETE (condition: "approved")
         - If critical issues found, route to ABORT (condition: "rejected")

      **Review Summary output contract:**
      ```markdown
      # Review Summary

      ## Overall Verdict: APPROVE / REJECT

      ## Summary
      {2-3 sentences consolidating all review results}

      ## Review Results
      | Review | Result | Key Findings |
      |--------|--------|--------------|
      | Architecture | APPROVE/REJECT | {Brief finding} |
      | Security | APPROVE/REJECT | {Brief finding} |
      | AI Antipattern | APPROVE/REJECT | {Brief finding} |

      ## Issues Requiring Attention
      | # | Severity | Source | Location | Issue |
      |---|----------|--------|----------|-------|
      | 1 | High | Security | `file:line` | Description |

      ## Improvement Suggestions
      - {Consolidated suggestions from all reviews}
      ```

  - name: pr-comment
    edit: false
    persona: pr-commenter
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
    rules:
      - condition: Comments posted
        next: COMPLETE
      - condition: Failed to post comments
        next: COMPLETE
    instruction_template: |
      ## Review Summary
      {previous_response}

      Post the review results to the PR as comments.

      **Procedure:**
      1. Extract the PR number from the task description
      2. Read all review reports in the Report Directory:
         - `01-architect-review.md` (Architecture review)
         - `02-security-review.md` (Security review)
         - `03-ai-review.md` (AI antipattern review)
         - `04-review-summary.md` (Consolidated summary)
      3. Filter findings by severity and post inline comments for Critical/High/Medium
      4. Post a summary comment with the following format:

      ```
      ## Automated Review Summary

      {Overall verdict and summary from 04-review-summary.md}

      ### Review Results
      | Review | Result |
      |--------|--------|
      | Architecture | {result} |
      | Security | {result} |
      | AI Antipattern | {result} |

      ### Key Findings
      {Bulleted list of important findings}

      ### Improvement Suggestions
      {Consolidated suggestions}

      ---
      *Generated by [takt](https://github.com/toruticas/takt) review-only piece*
      ```
